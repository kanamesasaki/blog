{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/20220125-read-pixels/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Blog"}},"markdownRemark":{"id":"fd053499-ca77-53fc-8526-c99e67f2ff85","excerpt":"やりたいこと WebGLとOpenGL ES Shading Language(GLSL ES)を用いると，ウェブブラウザ上で比較的簡単にグラフィック処理を行うことが出来る．\r\nこの環境でGPGPU(General-purpose computing on graphics processing units…","html":"<h2>やりたいこと</h2>\n<p>WebGLとOpenGL ES Shading Language(GLSL ES)を用いると，ウェブブラウザ上で比較的簡単にグラフィック処理を行うことが出来る．\r\nこの環境でGPGPU(General-purpose computing on graphics processing units)をやる準備として，GPUのフラグメントシェーダからCPUへのデータの受け渡しについて考えよう．</p>\n<details>\r\n<summary></summary>\r\nMithilfe von WebGL und OpenGL ES Shading Language (GLSL ES) kann man die Grafikverarbeitung relativ einfach in einem Webbrowser durchführen.\r\nUm GPGPU (General-purpose computing on graphics processing units) in dieser Umgebung durchzuführen, versuchen wir, Daten vom GPU Fragment Shader auf die CPU zu übertragen.\r\n</details>\n<h2>フラグメントシェーダのデータを色に変換する</h2>\n<p>もともとフラグメントシェーダの役割は，各ピクセルで表示するべき色を決めることである．\r\nこの処理をプログラミングしてやることで，表示されるポリゴンに好きな色を指定したり，グラデーションをつけたりすることもできる．\r\n一方，表示された色はWebGLのreadPixelsという関数を使うとJavaScript側で読みだすことも出来る．\r\nなので，渡したいデータを色として表示して，それを読みだしてやれば，フラグメントシェーダからCPUへデータを受け渡すことが出来る．</p>\n<p>色はRGBAの値で指定されるが，フラグメントシェーダではRGBAの値を0–1のfloatで指定するのに対して，JavaScript側では，RGBAの値を8ビットのunsigned intとして受け取るので注意しよう．</p>\n<p>32ビットのintを色に変換するには，次のように8ビットごとにバイナリを取り出して，0–1のfloatに変換してやればよい．</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">vec4</span> <span class=\"token function\">intToVec4</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> num<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">int</span> rIntValue <span class=\"token operator\">=</span> num <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x000000FF</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> gIntValue <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x0000FF00</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> bIntValue <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x00FF0000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">16</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> aIntValue <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xFF000000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">24</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">vec4</span> numColor <span class=\"token operator\">=</span> <span class=\"token keyword\">vec4</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">(</span>rIntValue<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">255.0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span><span class=\"token punctuation\">(</span>gIntValue<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">255.0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span><span class=\"token punctuation\">(</span>bIntValue<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">255.0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span><span class=\"token punctuation\">(</span>aIntValue<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">255.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \r\n    <span class=\"token keyword\">return</span> numColor<span class=\"token punctuation\">;</span> \r\n<span class=\"token punctuation\">}</span> </code></pre></div>\n<p>同様に32ビットのuintも次のように色に変換できる．</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">vec4</span> <span class=\"token function\">uintToVec4</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint</span> num<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">uint</span> rIntValue <span class=\"token operator\">=</span> num <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x000000FFu</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">uint</span> gIntValue <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x0000FF00u</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">uint</span> bIntValue <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x00FF0000u</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">16</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">uint</span> aIntValue <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xFF000000u</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">24</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">vec4</span> numColor <span class=\"token operator\">=</span> <span class=\"token keyword\">vec4</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">(</span>rIntValue<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">255.0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span><span class=\"token punctuation\">(</span>gIntValue<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">255.0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span><span class=\"token punctuation\">(</span>bIntValue<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">255.0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span><span class=\"token punctuation\">(</span>aIntValue<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">255.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \r\n    <span class=\"token keyword\">return</span> numColor<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>32ビットfloatの場合は，ビット列を変えずにfloatをuintに変換した後，uintを色に変換してやればよい．</p>\n<div class=\"gatsby-highlight\" data-language=\"glsl\"><pre class=\"language-glsl\"><code class=\"language-glsl\"><span class=\"token keyword\">vec4</span> <span class=\"token function\">floatToVec4</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span> val<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">uint</span> conv <span class=\"token operator\">=</span> <span class=\"token function\">floatBitsToUint</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token function\">uintToVec4</span><span class=\"token punctuation\">(</span>conv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<details>\r\n<summary></summary>\r\nDie Rolle des Fragment Shaders ist, für jedes Pixel eine Farbe zu bestimmen. Die gezeichnete Farbe kann von der CPU mit der WebGL Funktion readPixcels gelesen werden.\r\nDas heißt, wenn man die Daten als Farbe zeichnet, können die Daten von der GPU zur CPU übertragen werden.\r\n</details>\n<h2>色をデータとして読みだす</h2>\n<p>画面全体の色を，int，unsigned int，floatの配列としてJavaScript側で読み出す関数は次のような感じになる．</p>\n<p>まず，読み出しに必要な分だけバイナリ配列の領域を用意して，そこに色データを読み出す．\r\n必要なサイズは，ピクセル数×8ビット×RGBAである．\r\nこれを32ビットごとのまとまりとして認識し直せば，もともとのデータが得られる．</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">readInt32Array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">let</span> pixels <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>gl<span class=\"token punctuation\">.</span>drawingBufferWidth <span class=\"token operator\">*</span> gl<span class=\"token punctuation\">.</span>drawingBufferHeight <span class=\"token operator\">*</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  gl<span class=\"token punctuation\">.</span><span class=\"token function\">readPixels</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span>drawingBufferWidth<span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span>drawingBufferHeight<span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span><span class=\"token constant\">RGBA</span><span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span><span class=\"token constant\">UNSIGNED_BYTE</span><span class=\"token punctuation\">,</span> pixels<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Int32Array</span><span class=\"token punctuation\">(</span>pixels<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">function</span> <span class=\"token function\">readUint32Array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">let</span> pixels <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>gl<span class=\"token punctuation\">.</span>drawingBufferWidth <span class=\"token operator\">*</span> gl<span class=\"token punctuation\">.</span>drawingBufferHeight <span class=\"token operator\">*</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  gl<span class=\"token punctuation\">.</span><span class=\"token function\">readPixels</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span>drawingBufferWidth<span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span>drawingBufferHeight<span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span><span class=\"token constant\">RGBA</span><span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span><span class=\"token constant\">UNSIGNED_BYTE</span><span class=\"token punctuation\">,</span> pixels<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint32Array</span><span class=\"token punctuation\">(</span>pixels<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">function</span> <span class=\"token function\">readFloat32Array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">let</span> pixels <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>gl<span class=\"token punctuation\">.</span>drawingBufferWidth <span class=\"token operator\">*</span> gl<span class=\"token punctuation\">.</span>drawingBufferHeight <span class=\"token operator\">*</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  gl<span class=\"token punctuation\">.</span><span class=\"token function\">readPixels</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span>drawingBufferWidth<span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span>drawingBufferHeight<span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span><span class=\"token constant\">RGBA</span><span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span><span class=\"token constant\">UNSIGNED_BYTE</span><span class=\"token punctuation\">,</span> pixels<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Float32Array</span><span class=\"token punctuation\">(</span>pixels<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<details>\r\n<summary></summary>\r\nDie gezeichneten Farben können als ein int-, uint-, oder float-Array ausgelesen werden.\n<p>Zuerst sollte man den notwendigen Binary Buffer vorbereiten und die Farbdaten auslesen. Die notwendige Buffergröße ist: Pixels × 8-Bit × RGBA.\r\nDann sollen diese Binärdaten als 32-Bit Datan neu erkannt werden.</p>\n</details>","frontmatter":{"title":"フラグメントシェーダからCPUへのデータ受け渡し","date":"January 25, 2022","description":"Transfering data from the fragment shader to CPU by using WebGL readPixels","tags":["Programming"]}},"previous":{"fields":{"slug":"/20220124-gatsby-blog/"},"frontmatter":{"title":"GatsbyとGitHub Pagesで作るMarkdownブログ"}},"next":{"fields":{"slug":"/20220127-import-shader/"},"frontmatter":{"title":"GLSLコードをJavaScriptからimportする"}}},"pageContext":{"id":"fd053499-ca77-53fc-8526-c99e67f2ff85","previousPostId":"4465dfed-35d0-5569-8efc-23fc51661d64","nextPostId":"3d898268-3a6a-52f6-b301-d41711121395"}},
    "staticQueryHashes": ["2841359383","3257411868"]}